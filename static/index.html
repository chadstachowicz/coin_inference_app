<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Coin Grader | Numisking</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root {
      --gold-primary: #D4A84B;
      --gold-dark: #C49A3D;
      --gold-light: #E5C87A;
      --gold-gradient: linear-gradient(135deg, #D4A84B 0%, #C49A3D 50%, #B8923A 100%);
      --white: #FFFFFF;
      --gray-50: #F9FAFB;
      --gray-100: #F3F4F6;
      --gray-200: #E5E7EB;
      --gray-400: #9CA3AF;
      --gray-600: #4B5563;
      --gray-800: #1F2937;
      --gray-900: #111827;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      height: 100%;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    body {
      background: var(--gray-50);
      color: var(--gray-800);
      min-height: 100vh;
    }

    /* Header / Nav */
    .header {
      background: var(--white);
      border-bottom: 1px solid var(--gray-200);
      padding: 1rem 1.5rem;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
      color: var(--gold-primary);
      font-weight: 700;
      font-size: 1.25rem;
    }

    .logo i {
      font-size: 1.5rem;
    }

    .nav-links {
      display: none;
    }

    @media (min-width: 768px) {
      .nav-links {
        display: flex;
        gap: 2rem;
      }

      .nav-links a {
        color: var(--gray-600);
        text-decoration: none;
        font-weight: 500;
        font-size: 0.95rem;
        transition: color 0.2s;
      }

      .nav-links a:hover {
        color: var(--gold-primary);
      }
    }

    /* Hero Section */
    .hero {
      background: var(--gold-gradient);
      padding: 3rem 1.5rem;
      text-align: center;
      color: var(--white);
    }

    @media (min-width: 768px) {
      .hero {
        padding: 4rem 2rem;
      }
    }

    .hero h1 {
      font-size: 1.75rem;
      font-weight: 800;
      margin-bottom: 0.75rem;
    }

    @media (min-width: 768px) {
      .hero h1 {
        font-size: 2.5rem;
      }
    }

    .hero p {
      font-size: 1rem;
      opacity: 0.95;
      max-width: 500px;
      margin: 0 auto;
    }

    /* Main Content */
    .main-content {
      max-width: 1000px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }

    @media (min-width: 768px) {
      .main-content {
        padding: 3rem 2rem;
      }
    }

    /* Step Indicator */
    .steps {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-bottom: 2rem;
    }

    .step-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--gray-200);
      transition: all 0.3s;
    }

    .step-dot.active {
      background: var(--gold-primary);
      width: 28px;
      border-radius: 5px;
    }

    .step-dot.done {
      background: var(--gold-dark);
    }

    /* Coin Upload Section */
    .upload-section {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    @media (min-width: 768px) {
      .upload-section {
        flex-direction: row;
        gap: 2rem;
        justify-content: center;
      }
    }

    /* Upload Card */
    .upload-card {
      background: var(--white);
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 2px solid var(--gray-200);
      transition: all 0.3s;
      flex: 1;
      max-width: 100%;
    }

    @media (min-width: 768px) {
      .upload-card {
        max-width: 340px;
      }
    }

    .upload-card.inactive {
      opacity: 0.5;
      pointer-events: none;
    }

    .upload-card.has-image {
      border-color: var(--gold-primary);
    }

    .upload-card h3 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--gray-800);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .upload-card h3 i {
      color: var(--gold-primary);
    }

    /* Coin Preview */
    .coin-preview {
      position: relative;
      width: 200px;
      height: 200px;
      margin: 0 auto 1rem;
    }

    @media (min-width: 768px) {
      .coin-preview {
        width: 220px;
        height: 220px;
      }
    }

    .coin-preview-img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
      background: var(--gray-100);
      border: 3px solid var(--gray-200);
      display: none;
    }

    .coin-preview-img.visible {
      display: block;
      border-color: var(--gold-primary);
    }

    .coin-placeholder {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: var(--gray-100);
      border: 3px dashed var(--gray-300);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--gray-400);
    }

    .coin-placeholder i {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }

    .coin-placeholder span {
      font-size: 0.85rem;
    }

    .coin-placeholder.hidden {
      display: none;
    }

    /* Image requirements note */
    .image-requirements {
      font-size: 0.75rem;
      color: var(--gray-400);
      text-align: center;
      margin-top: 0.75rem;
    }

    /* Upload Buttons */
    .upload-buttons {
      display: flex;
      gap: 0.75rem;
      justify-content: center;
    }

    .btn {
      padding: 0.75rem 1.25rem;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border: none;
    }

    .btn-primary {
      background: var(--gold-gradient);
      color: var(--white);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(212, 168, 75, 0.4);
    }

    .btn-secondary {
      background: var(--white);
      color: var(--gray-600);
      border: 1px solid var(--gray-200);
    }

    .btn-secondary:hover {
      background: var(--gray-50);
      border-color: var(--gray-300);
    }

    input[type="file"] {
      display: none;
    }

    /* Company Select */
    .company-section {
      margin-top: 2rem;
      text-align: center;
    }

    .company-select {
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      border: 1px solid var(--gray-200);
      background: var(--white);
      font-size: 1rem;
      color: var(--gray-800);
      min-width: 250px;
      cursor: pointer;
    }

    .company-select:focus {
      outline: none;
      border-color: var(--gold-primary);
    }

    /* Grade Button */
    .grade-button-section {
      margin-top: 2rem;
      text-align: center;
    }

    .btn-grade {
      background: var(--gold-gradient);
      color: var(--white);
      padding: 1rem 3rem;
      font-size: 1.1rem;
      font-weight: 700;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .btn-grade:hover:not(:disabled) {
      transform: scale(1.02);
      box-shadow: 0 8px 25px rgba(212, 168, 75, 0.4);
    }

    .btn-grade:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Results Card */
    .results-card {
      display: none;
      background: var(--white);
      border-radius: 16px;
      padding: 2rem;
      margin-top: 2rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      text-align: center;
      animation: slideUp 0.4s ease;
    }

    .results-card.visible {
      display: block;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .grade-result {
      font-size: 4rem;
      font-weight: 800;
      background: var(--gold-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    @media (min-width: 768px) {
      .grade-result {
        font-size: 5rem;
      }
    }

    .grade-sheldon {
      font-size: 1.1rem;
      color: var(--gray-600);
      margin-top: 0.5rem;
    }

    .confidence-section {
      margin: 1.5rem auto;
      max-width: 300px;
    }

    .confidence-bar {
      height: 8px;
      background: var(--gray-100);
      border-radius: 4px;
      overflow: hidden;
    }

    .confidence-fill {
      height: 100%;
      background: var(--gold-gradient);
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .confidence-label {
      font-size: 0.85rem;
      color: var(--gray-500);
      margin-top: 0.5rem;
    }

    .btn-reset {
      margin-top: 1.5rem;
      background: var(--white);
      color: var(--gold-primary);
      border: 2px solid var(--gold-primary);
      padding: 0.75rem 2rem;
      border-radius: 50px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-reset:hover {
      background: var(--gold-primary);
      color: var(--white);
    }

    /* Tips Section */
    .tips-section {
      margin-top: 3rem;
      background: var(--white);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .tips-section h4 {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--gold-dark);
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .tips-section ul {
      list-style: none;
      color: var(--gray-600);
      font-size: 0.9rem;
    }

    .tips-section li {
      padding: 0.25rem 0;
      padding-left: 1.25rem;
      position: relative;
    }

    .tips-section li::before {
      content: '✓';
      position: absolute;
      left: 0;
      color: var(--gold-primary);
    }

    /* Loading Overlay */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .loading-overlay.visible {
      display: flex;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--gray-200);
      border-top-color: var(--gold-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      margin-top: 1rem;
      color: var(--gold-dark);
      font-weight: 500;
    }

    /* Camera Modal */
    .camera-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      z-index: 10000;
      flex-direction: column;
    }

    .camera-modal.visible {
      display: flex;
    }

    .camera-modal video {
      flex: 1;
      width: 100%;
      object-fit: cover;
    }

    .camera-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    .camera-overlay::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: min(75vw, 75vh);
      height: min(75vw, 75vh);
      border: 4px solid var(--gold-primary);
      border-radius: 50%;
      box-shadow: 0 0 0 9999px rgba(0,0,0,0.65);
    }

    .camera-hint {
      position: absolute;
      bottom: 140px;
      left: 50%;
      transform: translateX(-50%);
      color: var(--white);
      font-size: 0.95rem;
      text-shadow: 0 2px 4px rgba(0,0,0,0.8);
      white-space: nowrap;
    }

    .camera-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      padding: 2rem;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 3rem;
      background: linear-gradient(transparent, rgba(0,0,0,0.7));
    }

    .btn-shutter {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      border: 4px solid var(--white);
      background: transparent;
      cursor: pointer;
      position: relative;
    }

    .btn-shutter::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--white);
      transition: transform 0.1s;
    }

    .btn-shutter:active::before {
      transform: translate(-50%, -50%) scale(0.9);
    }

    .btn-cancel-camera {
      background: none;
      border: none;
      color: var(--white);
      font-size: 1rem;
      cursor: pointer;
      padding: 0.75rem 1.5rem;
    }

    /* Disclaimer Banner */
    .disclaimer-banner {
      background: linear-gradient(135deg, #1F2937 0%, #374151 100%);
      color: var(--white);
      padding: 0.75rem 1rem;
      text-align: center;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .disclaimer-banner i {
      color: var(--gold-light);
    }

    .disclaimer-banner strong {
      color: var(--gold-light);
    }

    /* Results Disclaimer */
    .results-disclaimer {
      margin-top: 1.5rem;
      padding: 1rem;
      background: #FEF3C7;
      border-radius: 8px;
      border-left: 4px solid #F59E0B;
      text-align: left;
      font-size: 0.85rem;
      color: #92400E;
    }

    .results-disclaimer i {
      margin-right: 0.5rem;
      color: #F59E0B;
    }

    /* Footer */
    .footer {
      text-align: center;
      padding: 2rem;
      color: var(--gray-400);
      font-size: 0.85rem;
      border-top: 1px solid var(--gray-200);
      margin-top: 3rem;
    }

    .footer a {
      color: var(--gold-primary);
      text-decoration: none;
    }

    /* Safe area for notched phones */
    @supports (padding-top: env(safe-area-inset-top)) {
      .header {
        padding-top: calc(1rem + env(safe-area-inset-top));
      }
      .camera-controls {
        padding-bottom: calc(2rem + env(safe-area-inset-bottom));
      }
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div class="loading-text">Analyzing coin...</div>
  </div>

  <!-- Camera Modal -->
  <div class="camera-modal" id="cameraModal">
    <video id="cameraVideo" autoplay playsinline></video>
    <div class="camera-overlay"></div>
    <div class="camera-hint">Center coin within the circle</div>
    <div class="camera-controls">
      <button class="btn-cancel-camera" onclick="closeCamera()">Cancel</button>
      <button class="btn-shutter" onclick="capturePhoto()"></button>
      <div style="width: 70px;"></div>
    </div>
    <canvas id="cameraCanvas" style="display: none;"></canvas>
  </div>

  <!-- Disclaimer Banner -->
  <div class="disclaimer-banner">
    <i class="fas fa-flask"></i>
    <span><strong>PROOF OF CONCEPT:</strong> This AI grader is experimental. Predicted grades are estimates only and should not be used for buying, selling, or insurance purposes.</span>
  </div>

  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <a href="https://numisking.com" class="logo">
        <i class="fas fa-coins"></i>
        <span>Numisking</span>
      </a>
      <nav class="nav-links">
        <a href="https://numisking.com">Home</a>
        <a href="https://numisking.com/marketplace">Marketplace</a>
        <a href="https://numisking.com/explore">Explore Sets</a>
        <a href="#">Coin Grader</a>
      </nav>
    </div>
  </header>

  <!-- Hero -->
  <section class="hero">
    <h1>AI Coin Grader</h1>
    <p>Upload your coin photos to get an instant Sheldon scale grade prediction</p>
  </section>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Steps -->
    <div class="steps">
      <div class="step-dot active" id="step1"></div>
      <div class="step-dot" id="step2"></div>
      <div class="step-dot" id="step3"></div>
    </div>

    <!-- Upload Section -->
    <div class="upload-section">
      <!-- Obverse Card -->
      <div class="upload-card" id="obverseCard">
        <h3><i class="fas fa-sun"></i> Obverse (Front)</h3>
        <div class="coin-preview">
          <img src="" class="coin-preview-img" id="obversePreview" alt="Obverse">
          <div class="coin-placeholder" id="obversePlaceholder">
            <i class="fas fa-camera"></i>
            <span>Tap to capture</span>
          </div>
        </div>
        <div class="upload-buttons">
          <button class="btn btn-primary" onclick="openCamera('obverse')">
            <i class="fas fa-camera"></i> Camera
          </button>
          <button class="btn btn-secondary" onclick="document.getElementById('obverseFile').click()">
            <i class="fas fa-image"></i> Gallery
          </button>
        </div>
        <div class="image-requirements">Min 512×512px • Just the coin • We'll resize</div>
        <input type="file" id="obverseFile" accept="image/*" onchange="handleFile(this, 'obverse')">
      </div>

      <!-- Reverse Card -->
      <div class="upload-card inactive" id="reverseCard">
        <h3><i class="fas fa-moon"></i> Reverse (Back)</h3>
        <div class="coin-preview">
          <img src="" class="coin-preview-img" id="reversePreview" alt="Reverse">
          <div class="coin-placeholder" id="reversePlaceholder">
            <i class="fas fa-camera"></i>
            <span>Tap to capture</span>
          </div>
        </div>
        <div class="upload-buttons">
          <button class="btn btn-primary" onclick="openCamera('reverse')">
            <i class="fas fa-camera"></i> Camera
          </button>
          <button class="btn btn-secondary" onclick="document.getElementById('reverseFile').click()">
            <i class="fas fa-image"></i> Gallery
          </button>
        </div>
        <div class="image-requirements">Min 512×512px • Just the coin • We'll resize</div>
        <input type="file" id="reverseFile" accept="image/*" onchange="handleFile(this, 'reverse')">
      </div>
    </div>

    <!-- Company Select -->
    <div class="company-section">
      <select class="company-select" id="companySelect">
        <option value="">Grading Company (optional)</option>
      </select>
    </div>

    <!-- Grade Button -->
    <div class="grade-button-section">
      <button class="btn-grade" id="gradeBtn" disabled onclick="submitForGrading()">
        <i class="fas fa-search"></i> Grade This Coin
      </button>
    </div>

    <!-- Results -->
    <div class="results-card" id="resultsCard">
      <div class="grade-result" id="gradeResult">MS64</div>
      <div class="grade-sheldon" id="gradeSheldon">Sheldon Scale: 64</div>
      <div class="confidence-section">
        <div class="confidence-bar">
          <div class="confidence-fill" id="confidenceFill" style="width: 0%"></div>
        </div>
        <div class="confidence-label">Confidence: <span id="confidenceText">0%</span></div>
      </div>
      <div class="results-disclaimer">
        <i class="fas fa-exclamation-triangle"></i>
        <strong>Disclaimer:</strong> This is an AI-generated estimate for entertainment purposes only. 
        For accurate grading, please submit your coin to PCGS, NGC, or another professional grading service. 
        Do not use this prediction for buying, selling, or valuation decisions.
      </div>
      <button class="btn-reset" onclick="resetApp()">
        <i class="fas fa-redo"></i> Grade Another Coin
      </button>
    </div>

    <!-- Tips -->
    <div class="tips-section">
      <h4><i class="fas fa-lightbulb"></i> Tips for Best Results</h4>
      <ul>
        <li><strong>Image size:</strong> At least 512×512 pixels (we'll resize automatically)</li>
        <li><strong>Framing:</strong> Just the coin, filling most of the frame</li>
        <li>Use good, even lighting without harsh shadows</li>
        <li>Center the coin within the circular guide</li>
        <li>Keep camera steady and parallel to the coin</li>
        <li>Avoid reflections and glare on the surface</li>
      </ul>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <p>Powered by <a href="https://numisking.com">Numisking</a> | AI Coin Grading</p>
  </footer>

  <script>
    // State
    let currentCapture = null;
    let obverseFile = null;
    let reverseFile = null;
    let cameraStream = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadCompanies();
    });

    // Load companies
    async function loadCompanies() {
      try {
        const response = await fetch('/companies');
        const data = await response.json();
        const select = document.getElementById('companySelect');
        
        if (data.companies && data.companies.length > 0) {
          data.companies.forEach(company => {
            const option = document.createElement('option');
            option.value = company;
            option.textContent = company;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.log('Could not load companies');
      }
    }

    // Open camera
    async function openCamera(side) {
      currentCapture = side;
      const modal = document.getElementById('cameraModal');
      const video = document.getElementById('cameraVideo');
      
      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({
          video: { 
            facingMode: 'environment',
            width: { ideal: 1920 },
            height: { ideal: 1920 }
          }
        });
        video.srcObject = cameraStream;
        modal.classList.add('visible');
      } catch (err) {
        alert('Could not access camera. Please use the Gallery option.');
        console.error('Camera error:', err);
      }
    }

    // Close camera
    function closeCamera() {
      const modal = document.getElementById('cameraModal');
      const video = document.getElementById('cameraVideo');
      
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
      }
      video.srcObject = null;
      modal.classList.remove('visible');
      currentCapture = null;
    }

    // Capture photo
    function capturePhoto() {
      const video = document.getElementById('cameraVideo');
      const canvas = document.getElementById('cameraCanvas');
      const ctx = canvas.getContext('2d');
      
      const viewportSize = Math.min(window.innerWidth, window.innerHeight);
      const circleRatio = 0.75;
      const videoAspect = video.videoWidth / video.videoHeight;
      const screenAspect = window.innerWidth / window.innerHeight;
      
      let cropSize, sx, sy;
      
      if (videoAspect > screenAspect) {
        const visibleWidth = video.videoHeight * screenAspect;
        cropSize = visibleWidth * circleRatio;
        sx = (video.videoWidth - cropSize) / 2;
        sy = (video.videoHeight - cropSize) / 2;
      } else {
        cropSize = video.videoWidth * circleRatio;
        sx = (video.videoWidth - cropSize) / 2;
        sy = (video.videoHeight - cropSize) / 2;
      }
      
      const outputSize = 1024;
      canvas.width = outputSize;
      canvas.height = outputSize;
      
      ctx.drawImage(video, sx, sy, cropSize, cropSize, 0, 0, outputSize, outputSize);
      
      canvas.toBlob(blob => {
        const file = new File([blob], `${currentCapture}.jpg`, { type: 'image/jpeg' });
        processCapture(file, currentCapture);
        closeCamera();
      }, 'image/jpeg', 0.92);
    }

    // Handle file from gallery
    function handleFile(input, side) {
      const file = input.files[0];
      if (file) {
        processCapture(file, side);
      }
    }

    // Process captured image
    function processCapture(file, side) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const preview = document.getElementById(side + 'Preview');
        const placeholder = document.getElementById(side + 'Placeholder');
        const card = document.getElementById(side + 'Card');
        
        preview.src = e.target.result;
        preview.classList.add('visible');
        placeholder.classList.add('hidden');
        card.classList.add('has-image');
        
        if (side === 'obverse') {
          obverseFile = file;
          document.getElementById('reverseCard').classList.remove('inactive');
          document.getElementById('step1').classList.remove('active');
          document.getElementById('step1').classList.add('done');
          document.getElementById('step2').classList.add('active');
        } else {
          reverseFile = file;
          document.getElementById('step2').classList.remove('active');
          document.getElementById('step2').classList.add('done');
          document.getElementById('step3').classList.add('active');
        }
        
        updateGradeButton();
      };
      reader.readAsDataURL(file);
    }

    // Update grade button
    function updateGradeButton() {
      document.getElementById('gradeBtn').disabled = !(obverseFile && reverseFile);
    }

    // Submit for grading
    async function submitForGrading() {
      if (!obverseFile || !reverseFile) return;
      
      const loading = document.getElementById('loadingOverlay');
      const btn = document.getElementById('gradeBtn');
      
      loading.classList.add('visible');
      btn.disabled = true;
      
      try {
        const formData = new FormData();
        formData.append('obverse', obverseFile);
        formData.append('reverse', reverseFile);
        
        const company = document.getElementById('companySelect').value;
        if (company) {
          formData.append('company', company);
        }
        
        const response = await fetch('/predict', {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.detail || 'Prediction failed');
        }
        
        const result = await response.json();
        
        document.getElementById('gradeResult').textContent = result.prediction;
        document.getElementById('gradeSheldon').textContent = `Sheldon Scale: ${result.sheldon_grade}`;
        document.getElementById('confidenceFill').style.width = `${result.confidence}%`;
        document.getElementById('confidenceText').textContent = `${result.confidence}%`;
        document.getElementById('resultsCard').classList.add('visible');
        document.getElementById('resultsCard').scrollIntoView({ behavior: 'smooth' });
        
      } catch (error) {
        alert('Error: ' + error.message);
      } finally {
        loading.classList.remove('visible');
        btn.disabled = false;
      }
    }

    // Reset app
    function resetApp() {
      obverseFile = null;
      reverseFile = null;
      
      ['obverse', 'reverse'].forEach(side => {
        const preview = document.getElementById(side + 'Preview');
        const placeholder = document.getElementById(side + 'Placeholder');
        const card = document.getElementById(side + 'Card');
        
        preview.src = '';
        preview.classList.remove('visible');
        placeholder.classList.remove('hidden');
        card.classList.remove('has-image');
      });
      
      document.getElementById('reverseCard').classList.add('inactive');
      document.getElementById('resultsCard').classList.remove('visible');
      document.getElementById('gradeBtn').disabled = true;
      
      document.getElementById('step1').className = 'step-dot active';
      document.getElementById('step2').className = 'step-dot';
      document.getElementById('step3').className = 'step-dot';
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  </script>
</body>
</html>
